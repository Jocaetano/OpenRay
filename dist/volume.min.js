(function(){var º={};!function(e,t){"function"==typeof define&&define.amd?define("box",t):º.Box=t()}(this,function(){"use strict";function e(e,t){this._origin=e,this._corner=t}return e.prototype={width:function(){return this._corner[0]-this._origin[0]},depth:function(){return this._corner[1]-this._origin[1]},height:function(){return this._corner[2]-this._origin[2]},center:function(){var e=[-((this._origin[0]+this._corner[0])/2),-((this._origin[1]+this._corner[1])/2),-((this._origin[2]+this._corner[2])/2)];return e},translate:function(e){for(var t=0;3>t;t++)this._origin[t]+=e[t],this._corner[t]+=e[t]},corner:function(e){switch(e){case 0:return this._origin;case 1:return[this._corner[0],this._origin[1],this._origin[2]];case 2:return[this._origin[0],this._corner[1],this._origin[2]];case 3:return[this._corner[0],this._corner[1],this._origin[2]];case 4:return[this._origin[0],this._origin[1],this._corner[2]];case 5:return[this._corner[0],this._origin[1],this._corner[2]];case 6:return[this._origin[0],this._corner[1],this._corner[2]];case 7:return this._corner}}},e}),function(e,t){"function"==typeof define&&define.amd?define("volume",["box"],t):º.Volume=t(º.Box)}(this,function(e){"use strict";function t(e,t){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2)+Math.pow(e.z-t.z,2))}function i(e,t,i){if(this._imageWidth=t.width,this._imageHeight=t.height,this._minDensity=e.first,this._maxDensity=e.second,this._imgContainer=[],this._boundDimDirty=!0,this._rescaleSlope=t.rescaleSlope||1,this._rescaleIntercept=t.rescaleIntercept||0,this._rescale=t.rescaleIntercept-this._minDensity,i){for(var n=0,r=i.length;r>n;n++)this.insertImage(i[n]);this.calculatePixelSpacing()}}return i.prototype={slice:function(e,t){var i={};return i.length=t-e,i._imgContainer=this._imgContainer.slice(e,t),i._imageWidth=this._imageWidth,i._minDensity=this._minDensity,i},_recalculateBounding:function(){for(var t=1,i=1,n=Math.max(this._imgContainer.length,1),r=0,s=this._imgContainer.length;s>r;r++){var a;a=this._imgContainer[r].imageInfo.width,t=Math.max(a,t),a=this._imgContainer[r].imageInfo.height,i=Math.max(a,i)}this._boundingBox=new e([0,0,0],[t*this._pixelSpacing.x,i*this._pixelSpacing.y,n*this._pixelSpacing.z]),this._dimensions=[t,i,n],this._boundDimDirty=!1},insertImage:function(e){this._boundDimDirty=!0,this._imgContainer.push(e);var t=e.densityLimits();t.first<this._minDensity&&(this._minDensity=t.first),t.second>this._maxDensity&&(this._maxDensity=t.second)},insertImages:function(e){for(var t=0,i=e.length;i>t;t++)this.insertImage(e[t])},boundingBox:function(){return this._boundDimDirty&&this._recalculateBounding(),this._boundingBox},calculatePixelSpacing:function(){if(!this._pixelSpacing){this._pixelSpacing={x:-1>>>0,y:-1>>>0,z:-1>>>0};var e=this._imgContainer[0].imageInfo,i=this._imgContainer[1].imageInfo;this._pixelSpacing.x=e.pixelSpacing.x,this._pixelSpacing.y=e.pixelSpacing.y,this._pixelSpacing.z=e.pixelSpacing.z||Math.min(e.sliceThickness,t(e.position,i.position))}return this._pixelSpacing},getPixelSpacing:function(){return this._pixelSpacing}},i}),function(e,t){"function"==typeof define&&define.amd?define("image",t):º.DicomImage=t()}(this,function(){"use strict";function e(e,t){switch(this.imageInfo=e,this.min=-1,this.max=-1,this.buffer=t,this.imageInfo.bitsAllocated){case 0:this.generateRGBData=this.from8toRGB;break;case 1:this.generateRGBData=this.buffer instanceof Int16Array?this.fromInt16toRGB:this.fromUint16toRGB;break;case 2:this.generateRGBData=function(){return console.log("24bit per sample not supported")};break;case 3:this.generateRGBData=function(){return console.log("32bit per sample not supported")};break;default:this.generateRGBData=function(){return console.log(this.imageInfo.bitsAllocated)}}}return e.prototype={densityLimits:function(){this.min=this.buffer[0],this.max=this.min;for(var e=0,t=this.imageInfo.size;t>e;++e){var i=this.buffer[e];i<this.min?this.min=i:i>this.max&&(this.max=i)}return{first:this.min*this.imageInfo.rescaleSlope+this.imageInfo.rescaleIntercept,second:this.max*this.imageInfo.rescaleSlope+this.imageInfo.rescaleIntercept}},generateRGBData:function(){},fromUint16toRGB:function(e){for(var t=new ArrayBuffer(2),i=new Uint16Array(t),n=new Uint8Array(t),r=0,s=0,a=this.imageInfo.size;a>s;++s)i[0]=this.buffer[s],r=3*s,e[r]=n[0],e[r+1]=n[1]},fromInt16toRGB:function(e){for(var t=new ArrayBuffer(2),i=new Int16Array(t),n=new Uint8Array(t),r=0,s=0,a=this.imageInfo.size;a>s;++s)i[0]=this.buffer[s]-this.min,r=3*s,e[r]=n[0],e[r+1]=n[1]},from8toRGB:function(e){var t=0;if(this.imageInfo.invert)for(var i=0,n=this.imageInfo.size;n>i;++i)t=3*i,e[t]=!this.buffer[i];else for(var i=0,n=this.imageInfo.size;n>i;++i)t=3*i,e[t]=this.buffer[i]},calculateHULookup:function(e){var t=new ArrayBuffer(e.byteLength);this.buffer=new Int16Array(t);for(var i=0,n=this.imageInfo.size;n>i;++i)this.buffer[i]=e[i]*this.imageInfo.rescaleSlope+this.imageInfo.rescaleIntercept}},e}),function(e,t){"function"==typeof define&&define.amd?define("imageLoader",t):º.ImageLoaderWorker=t()}(this,function(){"use strict";var e=URL.createObjectURL(new Blob(["("+function(){function e(e,t,n){var r=i(e),s=e.elements.x7fe00010,a=s.dataOffset,o=t*n;return 1===r?new Uint8Array(e.byteArray.buffer,a,o):2===r?new Uint16Array(e.byteArray.buffer,a,o):3===r?new Int16Array(e.byteArray.buffer,a,o):void 0}function t(e,t,i,n){var r=dicomParser.readEncapsulatedPixelData(e,e.elements.x7fe00010,n),s=new JpxImage;s.parse(r);var a=s.width,o=s.height;if(a!==t)throw"JPEG2000 decoder returned width of "+a+", when "+t+" is expected";if(o!==i)throw"JPEG2000 decoder returned width of "+o+", when "+i+" is expected";var h=s.tile,c=h.items;return c}function i(e){var t=e.uint16("x00280103"),i=e.uint16("x00280100");return 0===t&&8===i?1:0===t&&16===i?2:1===t&&16===i?3:void 0}postMessage(!1),onmessage=function(i){if(i.data.url)return importScripts(i.data.url+"/thirdy/dicomParser/dicomParser.min.js"),void importScripts(i.data.url+"/thirdy/jpeg/jpx.js");var n={},r=dicomParser.parseDicom(new Uint8Array(i.data));r.elements.x00280030&&(n.pixelSpacing={x:r.floatString("x00280030",0),y:r.floatString("x00280030",1)}),r.elements.x00200037&&(n.xOrientation={x:r.floatString("x00200037",0),y:r.floatString("x00200037",1),z:r.floatString("x00200037",2)},n.yOrientation={x:r.floatString("x00200037",3),y:r.floatString("x00200037",4),z:r.floatString("x00200037",5)}),r.elements.x00200032&&(n.position={x:r.floatString("x00200032",0),y:r.floatString("x00200032",1),z:r.floatString("x00200032",2)}),r.elements.x00280002&&(n.samplesPerPixel=r.uint16("x00280002",0)),r.elements.x00180050&&(n.sliceThickness=r.floatString("x00180050",0)),r.elements.x00200013&&(n.sliceNum=r.intString("x00200013",0)),r.elements.x00280103&&(n.pixelRepresentation=r.uint16("x00280103",0)),r.elements.x00280100&&(n.bitsAllocated=(r.uint16("x00280100",0)>>3)-1),r.elements.x00280010&&(n.height=r.uint16("x00280010",0)),r.elements.x00280011&&(n.width=r.uint16("x00280011",0)),r.elements.x00281052&&(n.rescaleIntercept=r.floatString("x00281052",0)),r.elements.x00281053&&(n.rescaleSlope=r.floatString("x00281053",0)),r.elements.x00080008&&(n.imageType=r.string("x00080008",0)),r.elements.x00100010&&(n.patientName=r.string("x00100010",0)),r.elements.x00100040&&(n.patientSex=r.string("x00100040",0)),r.elements.x00101005&&(n.patientBirthDate=r.string("x00101005",0)),r.elements.x00101010&&(n.patientAge=r.intString("x00101010",0)),r.elements.x00280008&&(n.numberOfFrames=r.intString("x00280008",0)),r.elements.x00280009&&(n.frameIncrementPointer=r.floatString("x00280009",0)),r.elements.x00181063&&(n.frameTime=r.floatString("x00181063",0)),r.elements.x00181065&&(n.frameTimeVector=r.floatString("x00181065",0));var s;if(r.elements.x00280004&&(s=r.string("x00280004",0)),n.invert="MONOCHROME1"===s,n.size=n.height*n.width,"RGB"===s||"PALETTE COLOR"===s||"YBR_FULL"===s||"YBR_FULL_422"===s||"YBR_PARTIAL_422"===s||"YBR_PARTIAL_420"===s||"YBR_RCT"===s)console.log("Color image not supported = "+s);else{var a,o=r.string("x00020010");a="1.2.840.10008.1.2.4.90"===o||"1.2.840.10008.1.2.4.91"===o?t(r,n.width,n.height,0):e(r,n.width,n.height)}postMessage([n,a])}}.toString()+")()"],{type:"application/javascript"}));return e}),function(e,t){"function"==typeof define&&define.amd?define("volume_factory",["volume","image","imageLoader"],t):window.VolumeFactory=t(º.Volume,º.DicomImage,º.ImageLoaderWorker)}(this,function(e,t,i){"use strict";function n(e,t){return e.imageInfo.sliceNum-t.imageInfo.sliceNum}function r(e,i,n,r,s){var a,o=[],h=0;switch(n){case 0:a=Uint8Array;break;case 1:a=Uint16Array;break;case 2:break;case 3:a=Uint32Array;break;default:a=Uint8Array}n++;for(var c=0;s>c;c++)o.push(new t(i,new a(e,h,r))),h+=r*n;return o}return{createDicomVolume:function(r,s){function a(i,a,h){return function(c){if(c.data)o.push(new t(c.data[0],c.data[1])),o.length==r.length&&(o.sort(n),s(new e(o[0].densityLimits(),o[0].imageInfo,o)));else{i.postMessage({url:document.location.protocol+"//"+document.location.host});for(var f=a;h>f;f++)i.postMessage(r[f])}}}for(var o=[],h=Math.min(r.length,navigator.hardwareConcurrency||2),c=Math.floor(r.length/h),f=[],g=0;h-1>g;g++)f[g]=new Worker(i),f[g].onmessage=a(f[g],c*g,c*(g+1));f[g]=new Worker(i),f[g].onmessage=a(f[g],c*g,r.length),window.URL.revokeObjectURL(i)},createVolumefromRaw:function(t,i,n,s){var a=n.width*n.height,o={};o.height=n.height,o.width=n.width,o.size=a,o.pixelSpacing=s,o.bitsAllocated=i,o.rescaleSlope=1,o.rescaleIntercept=0;var h=r(t,o,i,a,n.nslices);return new e(h[0].densityLimits(),o,h)}}});})();