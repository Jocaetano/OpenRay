define("box",[],function(){"use strict";function e(e,i){this._origin=e,this._corner=i}return e.prototype={width:function(){return this._corner[0]-this._origin[0]},depth:function(){return this._corner[1]-this._origin[1]},height:function(){return this._corner[2]-this._origin[2]},center:function(){var e=[-((this._origin[0]+this._corner[0])/2),-((this._origin[1]+this._corner[1])/2),-((this._origin[2]+this._corner[2])/2)];return e},translate:function(e){for(var i=0;3>i;i++)this._origin[i]+=e[i],this._corner[i]+=e[i]},corner:function(e){switch(e){case 0:return this._origin;case 1:return[this._corner[0],this._origin[1],this._origin[2]];case 2:return[this._origin[0],this._corner[1],this._origin[2]];case 3:return[this._corner[0],this._corner[1],this._origin[2]];case 4:return[this._origin[0],this._origin[1],this._corner[2]];case 5:return[this._corner[0],this._origin[1],this._corner[2]];case 6:return[this._origin[0],this._corner[1],this._corner[2]];case 7:return this._corner}}},e}),define("volume",["box"],function(e){"use strict";function i(e,i){return Math.sqrt(Math.pow(e.x-i.x,2)+Math.pow(e.y-i.y,2)+Math.pow(e.z-i.z,2))}function t(e,i,t){if(this._imageWidth=i.width,this._imageHeight=i.height,this._minDensity=e.first,this._maxDensity=e.second,this._imgContainer=[],this._boundDimDirty=!0,this._rescaleSlope=i.rescaleSlope||1,this._rescaleIntercept=i.rescaleIntercept||0,this._rescale=i.rescaleIntercept-this._minDensity,t){for(var n=0;n<t.length;n++)this.insertImage(t[n]);this.calculatePixelSpacing()}}return t.prototype={slice:function(e,i){var t={};return t.length=i-e,t._imgContainer=this._imgContainer.slice(e,i),t._imageWidth=this._imageWidth,t._minDensity=this._minDensity,t},_recalculateBounding:function(){for(var i=1,t=1,n=Math.max(this._imgContainer.length,1),r=0;r<this._imgContainer.length;r++){var s;s=this._imgContainer[r].imageInfo.width,i=Math.max(s,i),s=this._imgContainer[r].imageInfo.height,t=Math.max(s,t)}this._boundingBox=new e([0,0,0],[i*this._pixelSpacing.x,t*this._pixelSpacing.y,n*this._pixelSpacing.z]),this._dimensions=[i,t,n],this._boundDimDirty=!1},insertImage:function(e){this._boundDimDirty=!0,this._imgContainer.push(e);var i=e.densityLimits();i.first<this._minDensity&&(this._minDensity=i.first),i.second>this._maxDensity&&(this._maxDensity=i.second)},insertImages:function(e){for(var i=0;i<e.length;i++)this.insertImage(e[i])},boundingBox:function(){return this._boundDimDirty&&this._recalculateBounding(),this._boundingBox},calculatePixelSpacing:function(){if(!this._pixelSpacing){this._pixelSpacing={x:-1>>>0,y:-1>>>0,z:-1>>>0};var e=this._imgContainer[0].imageInfo,t=this._imgContainer[1].imageInfo;this._pixelSpacing.x=e.pixelSpacing.x,this._pixelSpacing.y=e.pixelSpacing.y,this._pixelSpacing.z=e.pixelSpacing.z||Math.min(e.sliceThickness,i(e.position,t.position))}return this._pixelSpacing},getPixelSpacing:function(){return this._pixelSpacing}},t}),define("image",[],function(){"use strict";function e(e,i){this.imageInfo=e,this.min=-1,this.max=-1,this.buffer=i}return e.prototype={densityLimits:function(){this.min=this.buffer[0],this.max=this.min;for(var e=0;e<this.imageInfo.size;++e){var i=this.buffer[e];i<this.min?this.min=i:i>this.max&&(this.max=i)}return{first:this.min*this.imageInfo.rescaleSlope+this.imageInfo.rescaleIntercept,second:this.max*this.imageInfo.rescaleSlope+this.imageInfo.rescaleIntercept}},generateRGBData:function(e){switch(this.imageInfo.bitsAllocated){case 8:this.from8toRGB(e);break;case 16:this.buffer instanceof Int16Array?this.fromInt16toRGB(e):this.fromUint16toRGB(e);break;case 24:break;case 32:console.log("32bit per sample not supported yet");break;default:console.log(this.imageInfo.bitsAllocated)}},fromUint16toRGB:function(e){for(var i=new ArrayBuffer(2),t=new Uint16Array(i),n=new Uint8Array(i),r=0,s=0;s<this.imageInfo.size;++s)t[0]=this.buffer[s],r=3*s,e[r]=n[0],e[r+1]=n[1]},fromInt16toRGB:function(e){for(var i=new ArrayBuffer(2),t=new Int16Array(i),n=new Uint8Array(i),r=0,s=0;s<this.imageInfo.size;++s)t[0]=this.buffer[s]-this.min,r=3*s,e[r]=n[0],e[r+1]=n[1]},from8toRGB:function(e){var i=0;if(this.imageInfo.invert)for(var t=0;t<this.imageInfo.size;++t)i=3*t,e[i]=!this.buffer[t];else for(var t=0;t<this.imageInfo.size;++t)i=3*t,e[i]=this.buffer[t]},calculateHULookup:function(e){var i=new ArrayBuffer(e.byteLength);this.buffer=new Int16Array(i);for(var t=0;t<this.imageInfo.size;++t)this.buffer[t]=e[t]*this.imageInfo.rescaleSlope+this.imageInfo.rescaleIntercept}},e}),define("imageLoader",["image"],function(e){function i(e,i,t){var r=n(e),s=e.elements.x7fe00010,a=s.dataOffset,o=i*t;return 1===r?new Uint8Array(e.byteArray.buffer,a,o):2===r?new Uint16Array(e.byteArray.buffer,a,o):3===r?new Int16Array(e.byteArray.buffer,a,o):void 0}function t(e,i,t,n){var r=dicomParser.readEncapsulatedPixelData(e,e.elements.x7fe00010,n),s=new JpxImage;s.parse(r);var a=s.width,o=s.height;if(a!==i)throw"JPEG2000 decoder returned width of "+a+", when "+i+" is expected";if(o!==t)throw"JPEG2000 decoder returned width of "+o+", when "+t+" is expected";var h=s.componentsCount;if(1!==h)throw"JPEG2000 decoder returned a componentCount of "+h+", when 1 is expected";var c=s.tiles.length;if(1!==c)throw"JPEG2000 decoder returned a tileCount of "+c+", when 1 is expected";var f=s.tiles[0],g=f.items;return g}function n(e){var i=e.uint16("x00280103"),t=e.uint16("x00280100");return 0===i&&8===t?1:0===i&&16===t?2:1===i&&16===t?3:void 0}var r=[];return{loadImage:function(n){var r={},s=dicomParser.parseDicom(new Uint8Array(n));s.elements.x00280030&&(r.pixelSpacing={x:s.floatString("x00280030",0),y:s.floatString("x00280030",1)}),s.elements.x00200037&&(r.xOrientation={x:s.floatString("x00200037",0),y:s.floatString("x00200037",1),z:s.floatString("x00200037",2)},r.yOrientation={x:s.floatString("x00200037",3),y:s.floatString("x00200037",4),z:s.floatString("x00200037",5)}),s.elements.x00200032&&(r.position={x:s.floatString("x00200032",0),y:s.floatString("x00200032",1),z:s.floatString("x00200032",2)}),s.elements.x00280002&&(r.samplesPerPixel=s.uint16("x00280002",0)),s.elements.x00180050&&(r.sliceThickness=s.floatString("x00180050",0)),s.elements.x00200013&&(r.sliceNum=s.intString("x00200013",0)),s.elements.x00280103&&(r.pixelRepresentation=s.uint16("x00280103",0)),s.elements.x00280100&&(r.bitsAllocated=s.uint16("x00280100",0)),s.elements.x00280010&&(r.height=s.uint16("x00280010",0)),s.elements.x00280011&&(r.width=s.uint16("x00280011",0)),s.elements.x00281052&&(r.rescaleIntercept=s.floatString("x00281052",0)),s.elements.x00281053&&(r.rescaleSlope=s.floatString("x00281053",0)),s.elements.x00080008&&(r.imageType=s.string("x00080008",0)),s.elements.x00100010&&(r.patientName=s.string("x00100010",0)),s.elements.x00100040&&(r.patientSex=s.string("x00100040",0)),s.elements.x00101005&&(r.patientBirthDate=s.string("x00101005",0)),s.elements.x00101010&&(r.patientAge=s.intString("x00101010",0)),s.elements.x00280008&&(r.numberOfFrames=s.intString("x00280008",0)),s.elements.x00280009&&(r.frameIncrementPointer=s.floatString("x00280009",0)),s.elements.x00181063&&(r.frameTime=s.floatString("x00181063",0)),s.elements.x00181065&&(r.frameTimeVector=s.floatString("x00181065",0));var a;if(s.elements.x00280004&&(a=s.string("x00280004",0)),r.invert="MONOCHROME1"===a,r.size=r.height*r.width,"RGB"===a||"PALETTE COLOR"===a||"YBR_FULL"===a||"YBR_FULL_422"===a||"YBR_PARTIAL_422"===a||"YBR_PARTIAL_420"===a||"YBR_RCT"===a)console.log("Color image not supported = "+a);else{var o,h=s.string("x00020010");o="1.2.840.10008.1.2.4.90"===h||"1.2.840.10008.1.2.4.91"===h?t(s,r.width,r.height,0):i(s,r.width,r.height)}var c=new e(r,o);return c},pushImage:function(e){r.push(e)}}}),define("volume_factory",["volume","imageLoader","image"],function(e,i,t){function n(e,i){return e.imageInfo.sliceNum-i.imageInfo.sliceNum}function r(e,i,n,r,s){for(var a,o=[],h=0,c=0;s>c;c++){switch(n){case 1:a=new Uint8Array(e,h,r);break;case 2:a=new Uint16Array(e,h,r);break;case 3:a=new Uint8Array(e,h,3*r);break;case 4:a=new Uint32Array(e,h,r);break;default:a=new Uint8Array(e,h,r)}var f=new t(i,a);o.push(f),h+=r*n}return o}return{createDicomVolume:function(t){var r=[];return t.forEach(function(e){r.push(i.loadImage(e))}),r.sort(n),new e(r[0].densityLimits(),r[0].imageInfo,r)},createVolumefromRaw:function(i,t,n,s){var a=n.width*n.height,o={};o.height=n.height,o.width=n.width,o.size=a,o.pixelSpacing=s,o.bitsAllocated=8*t,o.rescaleSlope=1,o.rescaleIntercept=0;var h=r(i,o,t,a,n.nslices);return new e(h[0].densityLimits(),o,h)}}});