(function(){var º={};!function(t,e){"function"==typeof define&&define.amd?define("glShader",e):º.GLShader=e()}(this,function(){"use strict";function t(t,e){this._gl=t,this._shader=this._gl.createShader(e),this._directives=[],this._extraCode="",this._source=""}return t.prototype={loadShaderFromURL:function(t){var e=this,r=function(){e.loadShaderFromString(this.responseText)},i=new XMLHttpRequest;i.open("GET",t,!1),i.onload=r,i.send()},loadShaderFromString:function(t){this._source=t,this.compile()},compile:function(){var t=this.appendDirectives(this._source);t+=this._extraCode,this._gl.shaderSource(this._shader,t),this._gl.compileShader(this._shader),this._gl.getShaderParameter(this._shader,this._gl.COMPILE_STATUS)||console.log(this._gl.getShaderInfoLog(this._shader))},addDirective:function(t){this._directives.push(t)},clearDirectives:function(){this._directives.length=0},appendDirectives:function(t){if(this._directives.length>0)for(var e=0,r=this._directives.length;r>e;e++)t=this._directives[e]+"\n"+t;return t},addExtraCode:function(t){this._extraCode+=t},clearExtraCode:function(){this._extraCode=""},getShader:function(){return this._shader},toJSON:function(){return{source:this._source,directives:this._directives,extraCode:this._extraCode}}},t}),function(t,e){"function"==typeof define&&define.amd?define("glProgram",["glShader"],e):º.GLProgram=e(º.GLShader)}(this,function(t){"use strict";function e(e){this._gl=e,this.program=this._gl.createProgram(),this.vertexShader=new t(e,this._gl.VERTEX_SHADER),this.fragShader=new t(e,this._gl.FRAGMENT_SHADER),this.attributes={},this.uniforms={}}return e.prototype={loadFragmentShader:function(t){this.fragShader.loadShaderFromURL(t)},loadVertexShader:function(t){this.vertexShader.loadShaderFromURL(t)},addExtraCodeFragment:function(t){this.fragShader.addExtraCode(t)},addExtraCodeVertex:function(t){this.vertexShader.addExtraCode(t)},addDirectiveFragment:function(t){this.fragShader.addDirective(t)},addDirectiveVertex:function(t){this.vertexShader.addDirective(t)},compileFragmentShader:function(){this.fragShader.compile()},compileVertexShader:function(){this.vertexShader.compile()},addAttribute:function(t){var e=this._gl.getAttribLocation(this.program,t);return this._gl.enableVertexAttribArray(e),e},vertexAttribPointer:function(t,e,r){var i;if(t)i=this.attributes[t],this._gl.vertexAttribPointer(i.location,e,r,!1,0,0);else for(var t in this.attributes)i=this.attributes[t],this._gl.bindBuffer(this._gl.ARRAY_BUFFER,i.buffer),this._gl.vertexAttribPointer(i.location,i.bufferSize,i.bufferType,!1,0,0)},bindBufferToAttrib:function(t,e,r,i){return this.attributes[i]?(this.attributes[i].buffer=t,this.attributes[i].bufferSize=e,void(this.attributes[i].bufferType=r)):void console.log("Invalid attributeName")},addArrayBuffer:function(t,e,r,i){if(!this.attributes[i])return void console.log("Invalid attributeName");var n=this._gl.createBuffer();return this._gl.bindBuffer(this._gl.ARRAY_BUFFER,n),this._gl.bufferData(this._gl.ARRAY_BUFFER,t,this._gl.STATIC_DRAW),this.attributes[i].buffer=n,this.attributes[i].bufferSize=e,this.attributes[i].bufferType=r,n},drawArrays:function(t,e,r){for(var i in this.attributes){var n=this.attributes[i];this._gl.bindBuffer(this._gl.ARRAY_BUFFER,n.buffer),this._gl.vertexAttribPointer(n.location,n.bufferSize,n.bufferType,!1,0,0)}this._gl.drawArrays(t,e,r)},addElementArrayBuffer:function(t){this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,this._gl.createBuffer()),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,t,this._gl.STATIC_DRAW)},addUniform:function(t){return this._gl.getUniformLocation(this.program,t)},getProgram:function(){return this.program},bind:function(){this._gl.useProgram(this.program)},linkProgram:function(){if(this._gl.linkProgram(this.program),!this._gl.getProgramParameter(this.program,this._gl.LINK_STATUS))return void console.log(this._gl.getProgramInfoLog(this.program));for(var t,e,r=this._gl.getProgramParameter(this.program,this._gl.ACTIVE_ATTRIBUTES),i=0;r>i;i++)t=this._gl.getActiveAttrib(this.program,i),e=this._gl.getAttribLocation(this.program,t.name),this._gl.enableVertexAttribArray(e),this.attributes[t.name]={location:e};for(r=this._gl.getProgramParameter(this.program,this._gl.ACTIVE_UNIFORMS),i=0;r>i;i++)t=this._gl.getActiveUniform(this.program,i),e=this._gl.getUniformLocation(this.program,t.name),this.uniforms[t.name]=e},restartProgram:function(){this._gl.deleteProgram(this.program),this.program=this._gl.createProgram(),this.attachShaders(),this.linkProgram()},attachShaders:function(){this._gl.attachShader(this.program,this.vertexShader.getShader()),this._gl.attachShader(this.program,this.fragShader.getShader())},toJSON:function(){return{vertexShader:this.vertexShader,fragShader:this.fragShader}}},e}),function(t,e){"function"==typeof define&&define.amd?define("fbo",e):º.FrameBufferObject=e()}(this,function(){"use strict";function t(t){this._gl=t,this._fbo=this._gl.createFramebuffer(),this.renderBuffer={}}return t.prototype={bind:function(){this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,this._fbo)},unbind:function(){this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,null)},attachColor:function(t,e){this._gl.framebufferTexture2D(this._gl.FRAMEBUFFER,this._gl.COLOR_ATTACHMENT0+e,this._gl.TEXTURE_2D,t.getTextureID(),0)},createDepthRenderBuffer:function(t,e,r){this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,this._fbo),this.renderBuffer[r]=this._gl.createRenderbuffer(),this._gl.bindRenderbuffer(this._gl.RENDERBUFFER,this.renderBuffer[r]),this._gl.renderbufferStorage(this._gl.RENDERBUFFER,this._gl.DEPTH_COMPONENT16,t,e),this._gl.framebufferRenderbuffer(this._gl.FRAMEBUFFER,r,this._gl.RENDERBUFFER,this.renderBuffer[r])},changeRenderBufferSize:function(t,e,r){this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,this._fbo),this._gl.bindRenderbuffer(this._gl.RENDERBUFFER,this.renderBuffer[r]),this._gl.renderbufferStorage(this._gl.RENDERBUFFER,this._gl.DEPTH_COMPONENT16,t,e)}},t}),function(t,e){"function"==typeof define&&define.amd?define("glTexture2d",e):º.GLTexture2D=e()}(this,function(){"use strict";function t(t,e,r,i){this._gl=t,"object"==typeof e?this.loadFromVolume(e):this.createTexture(e,r,i)}return t.prototype={createTexture:function(t,e,r){this.width=t,this.height=e,this.format=r,this._gl.deleteTexture(this.tex),this.tex=this._gl.createTexture(),this._gl.bindTexture(this._gl.TEXTURE_2D,this.tex),this._gl.texImage2D(this._gl.TEXTURE_2D,0,r,t,e,0,r,this._gl.UNSIGNED_BYTE,null),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR)},changeSize:function(t,e){this.width=t,this.height=e,this._gl.bindTexture(this._gl.TEXTURE_2D,this.tex),this._gl.texImage2D(this._gl.TEXTURE_2D,0,this.format,t,e,0,this.format,this._gl.UNSIGNED_BYTE,null)},bind:function(t){t=t||0,this._gl.activeTexture(this._gl.TEXTURE0+t),this._gl.bindTexture(this._gl.TEXTURE_2D,this.tex)},getTextureID:function(){return this.tex},loadFromVolume:function(t){var e=t._imageWidth,r=Math.ceil(Math.sqrt(t._imgContainer.length));this.createTexture((e+2)*r,(e+2)*r,this._gl.RGB);for(var i=3,n=8;(e+2)*i*r%n;)n>>=1;this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,n);for(var s=e*i,a=(e+2)*i,o=e*s,h=new ArrayBuffer(o+(e+2)*a*r*r),f=new Uint8Array(h,0,o),u=new Uint8Array(h,o),l=0,c=t._imgContainer.length;c>l;l++){t._imgContainer[l].generateRGBData(f);var g=l%r*a,d=Math.floor(l/r)*(e+2);u.set(new Uint8Array(h,0,i),d*a*r+g),u.set(new Uint8Array(h,0,s),d*a*r+g+i),u.set(new Uint8Array(h,s-i,i),d*a*r+g+s+i);for(var _=d+1,m=0;e>m;_++,m++)u.set(new Uint8Array(h,m*s,i),_*a*r+g),u.set(new Uint8Array(h,m*s,s),_*a*r+g+i),u.set(new Uint8Array(h,m*s+(s-i),i),_*a*r+g+s+i);u.set(new Uint8Array(h,(m-1)*s,i),_*a*r+g),u.set(new Uint8Array(h,(m-1)*s,s),_*a*r+g+i),u.set(new Uint8Array(h,o-i,i),_*a*r+g+s+i)}this.updatePixels(u,this._gl.RGB)},updatePixels:function(t,e){this._gl.bindTexture(this._gl.TEXTURE_2D,this.tex),this._gl.texImage2D(this._gl.TEXTURE_2D,0,e,this.width,this.height,0,e,this._gl.UNSIGNED_BYTE,t),this._gl.bindTexture(this._gl.TEXTURE_2D,null)}},t}),function(t,e){"function"==typeof define&&define.amd?define("color",e):º.Color=e()}(this,function(){"use strict";function t(t,e,r,i){var n=new ArrayBuffer(4);this.color8=new Uint8ClampedArray(n),this.color32=new Uint32Array(n),this.color8[0]=t||0,this.color8[1]=e||0,this.color8[2]=r||0,this.color8[3]=i||0,this.r=this.color8[0],this.g=this.color8[1],this.b=this.color8[2],this.a=this.color8[3],this.rgba=this.color32[0]}return t.prototype={multiply:function(e){return new t(this.r*e,this.g*e,this.b*e,this.a*e)},plus:function(e){return new t(this.r+e.r,this.g+e.g,this.b+e.b,this.a+e.a)},minus:function(e){return new t(this.r-e.r,this.g-e.g,this.b-e.b,this.a-e.a)},data:function(){return this.color8},data32:function(){return this.color32},updateRGBA:function(){this.r=this.color8[0],this.g=this.color8[1],this.b=this.color8[2],this.a=this.color8[3]},toJSON:function(){return{r:this.r,g:this.g,b:this.b,a:this.a}}},t}),function(t,e){"function"==typeof define&&define.amd?define("transferFunciton",e):º.TransferFunction=e()}(this,function(){"use strict";function t(t,e,r,i){if(r=r||0,i=i||t.length,t[0]==e)return 0;for(var n=r;i>n;n++)if(t[n]>=e)return n-1;return 0}function e(t,e,r,i){r=r||0,i=i||t.length;for(var n=r;i>n;n++)if(t[n]>e)return n;return t.length-1}function r(t,e,r,i){var n=t[e].rgba,s=t[r].rgba,a=16711935,o=65280,h=~~(256*i),f=256-h,u=(n&a)*f+(s&a)*h>>>8&a|(n&o)*f+(s&o)*h>>>8&o,l=n>>>24,c=s>>>24,g=l+~~((c-l)*i);return g<<=24,u=g|u}function i(t,e){this.nStops=0,this.size=e-t+1,this._min=t,this._max=e,this._intervals=[],this._colors=[],this._observers=[];var r=new ArrayBuffer(4*this.size);this.data=new Uint8Array(r),this.data32=new Uint32Array(r)}return i.prototype={addObserver:function(t){this._observers.push(t)},notifyObservers:function(){this._observers.forEach(function(t){t()})},createData:function(){for(var t=0,e=this.size;e>t;t++){var r=t/(this.size-1);this.data32[t]=this.getColorAt(r)}},push:function(t,e){this._intervals.push(t),this._colors.push(e),this.nStops++},_getAoE:function(t){if(!(this.nStops<2)){var e,r=0,i=0;return 0==t?(r=~~(this._intervals[1]*this.size),e=new Uint32Array(this.data32.buffer,4,r)):t==this.nStops-1?(i=~~(this._intervals[t-1]*this.size),r=~~(this._intervals[t]*this.size)-i,e=new Uint32Array(this.data32.buffer,4*i+4,r-2)):(i=~~(this._intervals[t-1]*this.size),r=~~(this._intervals[t+1]*this.size)-i,e=new Uint32Array(this.data32.buffer,4*i+4,r-2)),{data:e,offset:i}}},_updateData:function(t,e){for(var r=0,i=0,n=t.length;n>i;i++)r=(i+e)/(this.size-1),t[i]=this.getColorAt(r)},insert:function(t,r){var i=e(this._intervals,t);this._intervals.splice(i,0,t),this._colors.splice(i,0,r),this.nStops++;var n=this._getAoE(i);return this._updateData(n.data,n.offset),this.notifyObservers(),i},remove:function(t){var e=this._getAoE(t);this._colors.splice(t,1),this._intervals.splice(t,1),this.nStops--,this._updateData(e.data,e.offset),this.notifyObservers()},updateColor:function(t,e){this._colors[t]=e;var r=this._getAoE(t);this._updateData(r.data,r.offset),this.notifyObservers()},moveColor:function(t,e){this._intervals[t]=e;var r=0;e>this._intervals[t+1]?(this.swap(t,t+1),r=1):e<this._intervals[t-1]&&(this.swap(t,t-1),r=-1);var i=this._getAoE(t+r);return this._updateData(i.data,i.offset),this.notifyObservers(),r},swap:function(t,e){var r=this._intervals.splice(t,1),i=this._colors.splice(t,1);this._intervals.splice(e,0,r[0]),this._colors.splice(e,0,i[0])},setRange:function(t,e){this._min=t,this._max=e,this._size=e-t+1},getColorAt:function(i){var n=t(this._intervals,i),s=e(this._intervals,i,n),a=0;return this._intervals[s]!=this._intervals[n]&&(a=(i-this._intervals[n])/(this._intervals[s]-this._intervals[n])),r(this._colors,n,s,a)},serialize:function(){var t=new ArrayBuffer(1+8*this.nStops),e=new DataView(t),r=new Uint8Array(t);r[0]=this.nStops;for(var i=0,n=this.nStops;n>i;i++){e.setFloat32(8*i+1,this.getInterval(i));var s=this._colors[i];r[8*i+5]=s.r,r[8*i+6]=s.g,r[8*i+7]=s.b,r[8*i+8]=s.a}return r},getInterval:function(t){return this._intervals[t]*(this._max-this._min)+this._min},getRangeMin:function(){return this._min},getRangeMax:function(){return this._max},toJSON:function(){return{nStops:this.nStops,size:this.size,_min:this._min,_max:this._max,_intervals:this._intervals,_colors:this._colors}}},i}),function(t){"use strict";var e={};"undefined"==typeof exports?"function"==typeof define&&"object"==typeof define.amd&&define.amd?(e.exports={},define("glMatrix",[],function(){return e.exports})):e.exports="undefined"!=typeof window?window:t:e.exports=exports,function(t){if(!e)var e=1e-6;if(!r)var r="undefined"!=typeof Float32Array?Float32Array:Array;if(!i)var i=Math.random;var n={};n.setMatrixArrayType=function(t){r=t},"undefined"!=typeof t&&(t.glMatrix=n);var s=Math.PI/180;n.toRadian=function(t){return t*s};var a={};a.clone=function(t){var e=new r(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},a.fromValues=function(t,e,i){var n=new r(3);return n[0]=t,n[1]=e,n[2]=i,n},a.add=function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t},a.normalize=function(t,e){var r=e[0],i=e[1],n=e[2],s=r*r+i*i+n*n;return s>0&&(s=1/Math.sqrt(s),t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s),t},a.transformMat4=function(t,e,r){var i=e[0],n=e[1],s=e[2],a=r[3]*i+r[7]*n+r[11]*s+r[15];return a=a||1,t[0]=(r[0]*i+r[4]*n+r[8]*s+r[12])/a,t[1]=(r[1]*i+r[5]*n+r[9]*s+r[13])/a,t[2]=(r[2]*i+r[6]*n+r[10]*s+r[14])/a,t},"undefined"!=typeof t&&(t.vec3=a);var o={};o.create=function(){var t=new r(16);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},o.clone=function(t){var e=new r(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},o.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},o.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},o.multiply=function(t,e,r){var i=e[0],n=e[1],s=e[2],a=e[3],o=e[4],h=e[5],f=e[6],u=e[7],l=e[8],c=e[9],g=e[10],d=e[11],_=e[12],m=e[13],v=e[14],p=e[15],x=r[0],b=r[1],E=r[2],R=r[3];return t[0]=x*i+b*o+E*l+R*_,t[1]=x*n+b*h+E*c+R*m,t[2]=x*s+b*f+E*g+R*v,t[3]=x*a+b*u+E*d+R*p,x=r[4],b=r[5],E=r[6],R=r[7],t[4]=x*i+b*o+E*l+R*_,t[5]=x*n+b*h+E*c+R*m,t[6]=x*s+b*f+E*g+R*v,t[7]=x*a+b*u+E*d+R*p,x=r[8],b=r[9],E=r[10],R=r[11],t[8]=x*i+b*o+E*l+R*_,t[9]=x*n+b*h+E*c+R*m,t[10]=x*s+b*f+E*g+R*v,t[11]=x*a+b*u+E*d+R*p,x=r[12],b=r[13],E=r[14],R=r[15],t[12]=x*i+b*o+E*l+R*_,t[13]=x*n+b*h+E*c+R*m,t[14]=x*s+b*f+E*g+R*v,t[15]=x*a+b*u+E*d+R*p,t},o.mul=o.multiply,o.translate=function(t,e,r){var i,n,s,a,o,h,f,u,l,c,g,d,_=r[0],m=r[1],v=r[2];return e===t?(t[12]=e[0]*_+e[4]*m+e[8]*v+e[12],t[13]=e[1]*_+e[5]*m+e[9]*v+e[13],t[14]=e[2]*_+e[6]*m+e[10]*v+e[14],t[15]=e[3]*_+e[7]*m+e[11]*v+e[15]):(i=e[0],n=e[1],s=e[2],a=e[3],o=e[4],h=e[5],f=e[6],u=e[7],l=e[8],c=e[9],g=e[10],d=e[11],t[0]=i,t[1]=n,t[2]=s,t[3]=a,t[4]=o,t[5]=h,t[6]=f,t[7]=u,t[8]=l,t[9]=c,t[10]=g,t[11]=d,t[12]=i*_+o*m+l*v+e[12],t[13]=n*_+h*m+c*v+e[13],t[14]=s*_+f*m+g*v+e[14],t[15]=a*_+u*m+d*v+e[15]),t},o.rotateX=function(t,e,r){var i=Math.sin(r),n=Math.cos(r),s=e[4],a=e[5],o=e[6],h=e[7],f=e[8],u=e[9],l=e[10],c=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=s*n+f*i,t[5]=a*n+u*i,t[6]=o*n+l*i,t[7]=h*n+c*i,t[8]=f*n-s*i,t[9]=u*n-a*i,t[10]=l*n-o*i,t[11]=c*n-h*i,t},o.rotateY=function(t,e,r){var i=Math.sin(r),n=Math.cos(r),s=e[0],a=e[1],o=e[2],h=e[3],f=e[8],u=e[9],l=e[10],c=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=s*n-f*i,t[1]=a*n-u*i,t[2]=o*n-l*i,t[3]=h*n-c*i,t[8]=s*i+f*n,t[9]=a*i+u*n,t[10]=o*i+l*n,t[11]=h*i+c*n,t},o.frustum=function(t,e,r,i,n,s,a){var o=1/(r-e),h=1/(n-i),f=1/(s-a);return t[0]=2*s*o,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*s*h,t[6]=0,t[7]=0,t[8]=(r+e)*o,t[9]=(n+i)*h,t[10]=(a+s)*f,t[11]=-1,t[12]=0,t[13]=0,t[14]=a*s*2*f,t[15]=0,t},"undefined"!=typeof t&&(t.mat4=o)}(e.exports)}(this),function(t,e){"function"==typeof define&&define.amd?define("camera",["glMatrix"],e):º.Camera=e(window)}(this,function(t){"use strict";function e(e,r,i,n,s){e=e||1,r=r||0,i=i||0,n=n||0,s=s||t.mat4.create(),this.pos=t.vec3.fromValues(r,i,n),this.mvMatrix=t.mat4.create(),t.mat4.translate(this.mvMatrix,this.mvMatrix,[r,i,n]),t.mat4.multiply(this.mvMatrix,this.mvMatrix,s),this.pMatrix=t.mat4.create(),t.mat4.frustum(this.pMatrix,-10*e,10*e,-10*e,10*e,200,2500),this.reset=this.reset(this.pos,this.mvMatrix,this.pMatrix),this._observers=[]}return e.prototype={addObserver:function(t){this._observers.push(t)},notifyObservers:function(){this._observers.forEach(function(t){t()})},rotate:function(e,r){var i=t.mat4.create();t.mat4.rotateY(i,i,e/60);var n=t.mat4.create();t.mat4.rotateX(n,n,r/60);var s=t.mat4.create();t.mat4.multiply(s,i,n),t.vec3.transformMat4(this.pos,this.pos,s),t.vec3.normalize(this.pos,this.pos);var a=this.mvMatrix[12],o=this.mvMatrix[13],h=this.mvMatrix[14];this.mvMatrix[12]-=a,this.mvMatrix[13]-=o,this.mvMatrix[14]-=h,t.mat4.multiply(this.mvMatrix,s,this.mvMatrix),this.mvMatrix[12]+=a,this.mvMatrix[13]+=o,this.mvMatrix[14]+=h,this.notifyObservers()},translate:function(e,r){t.vec3.add(this.pos,this.pos,t.vec3.fromValues(e,-r,0)),t.vec3.normalize(this.pos,this.pos),this.mvMatrix[12]+=e,this.mvMatrix[13]-=r,this.notifyObservers()},changeZoom:function(t){var e=0>-t?.9:1.1;this.pMatrix[0]*=e,this.pMatrix[5]*=e,this.notifyObservers()},reset:function(e,r,i){var n=t.vec3.clone(e),s=t.mat4.clone(r),a=t.mat4.clone(i);return function(){this.pos=n,t.mat4.copy(this.mvMatrix,s),t.mat4.copy(this.pMatrix,a),this.notifyObservers()}}},e}),function(t,e){"function"==typeof define&&define.amd?define("raycaster",["glProgram","fbo","glTexture2d","color","transferFunciton","camera"],e):window.openray=e(º.GLProgram,º.FrameBufferObject,º.GLTexture2D,º.Color,º.TransferFunction,º.Camera)}(this,function(t,e,r,i,n,s){"use strict";function a(){var e=new t(x);e.loadVertexShader("../shaders/appShader.vert"),e.loadFragmentShader("../shaders/appShader.frag"),e.attachShaders(),e.linkProgram(),e.bind();var r=[2,0,0,0,0,2,0,0,0,0,-1,0,-1,-1,-0,1];x.uniformMatrix4fv(e.uniforms.uPMatrix,!1,r);var i=[0,0,1,0,0,1,1,1];return e.addArrayBuffer(new Float32Array(i),2,x.FLOAT,"aVertexPosition"),e}function o(){var e=new t(x);return e.loadVertexShader("../shaders/shader.vert"),e.loadFragmentShader("../shaders/shader.frag"),e.attachShaders(),e.linkProgram(),e}function h(){var e=new t(x);C>1&&e.addDirectiveFragment("#define NUMBER_SLICES_"+C),O&&e.addDirectiveFragment("#define USE_PHONG_SHADING"),L&&e.addDirectiveFragment("#define USE_GRADIENT_ON_ALPHA"),e.loadVertexShader("../shaders/shader.vert"),e.loadFragmentShader("../shaders/raycast.frag");var r=f();return e.addExtraCodeFragment(r),e.compileFragmentShader(),e.attachShaders(),e.linkProgram(),e}function f(){var t="\nuniform sampler2D volumeTexture1;\n";if(t+="\n",t+="float voxel(vec3 pos) {\n",t+="	float slice = pos.z * numberOfSlices;\n",t+="	vec3 rgb = voxelVolume(pos, "+P[0]+".0, volumeTexture1, slice);\n",t+="	return ((rgb.g*65280.0 + rgb.r*255.0) * "+b._rescaleSlope+".0) + "+b._rescale+".0;\n",t+="}",C>1){t="\n";for(var e=0;C>e;e++)t+="uniform sampler2D volumeTexture"+(e+1)+" ;\n";t+="\n",t+="float voxel(vec3 pos) {\n",t+="	vec3 rgb;\n",t+="	float slice = pos.z * numberOfSlices;\n",t+="	if(slice < "+(P[0]-1)+".0) {\n",t+="		rgb = voxelVolume(pos, "+P[0]+".0 , volumeTexture1, slice);\n",t+="	}\n";for(var r=P[0],i=1;C-1>i;i++)t+="	else if(slice < "+r+".0) {\n",t+="		rgb = voxelVolumeIntersection(pos, "+Math.ceil(Math.sqrt(P[i-1]))+".0, "+Math.ceil(Math.sqrt(P[i]))+".0, volumeTexture"+i+", volumeTexture"+(i+1)+", slice - "+(r-P[i-1])+".0);\n",t+="	}\n",t+="	else if(slice < "+(r+P[i]-1)+".0) {\n",t+="		rgb = voxelVolume(pos, "+P[i]+".0, volumeTexture"+(i+1)+", slice - "+r+".0);\n",t+="	}\n",r+=P[i];t+="	else if(slice < "+r+".0) {\n",t+="		rgb = voxelVolumeIntersection(pos, "+Math.ceil(Math.sqrt(P[i-1]))+".0, "+Math.ceil(Math.sqrt(P[i]))+".0, volumeTexture"+i+", volumeTexture"+(i+1)+", slice - "+(r-P[i-1])+".0);\n",t+="	}\n",t+="	else if(slice < "+(r+P[i])+".0) {\n",t+="		rgb = voxelVolume(pos, "+P[i]+".0, volumeTexture"+(i+1)+", slice - "+r+".0);\n",t+="	}\n",t+="	return ((rgb.g*65280.0 + rgb.r*255.0) * "+b._rescaleSlope+".0) + "+b._rescale+".0;\n",t+="}"}return t}function u(){var t=b.boundingBox(),e=[b.getPixelSpacing().x,b.getPixelSpacing().y,b.getPixelSpacing().z],r=Math.min(e[0],Math.min(e[1],e[2])),i=.5*r;console.log("Sampling steps: "+e),console.log("Sampling step: "+i),console.log("Box: "+t.width()+"  "+t.depth()+"  "+t.height()),console.log("Número de slices : "+P.length),T.bind(),x.uniform1i(T.uniforms.volumeTexture1,1);for(var n=1;C>n;n++)x.uniform1i(T.uniforms["volumeTexture"+(n+1)],n+1);x.uniform2f(T.uniforms.textureSize,w,D),x.uniform1i(T.uniforms.raysEndTexture,++n),x.uniform1i(T.uniforms.transferFunctionTexture,++n),x.uniform3f(T.uniforms.volumeSize,t.width(),t.depth(),t.height()),x.uniform1f(T.uniforms.numberOfSlices,b._imgContainer.length),x.uniform1f(T.uniforms.samplingStep,i),x.uniform1f(T.uniforms.volumeSpacing,r),x.uniform1f(T.uniforms.dicomSize,b._imageWidth),x.uniform3f(T.uniforms.lightDirection,G.position[0],G.position[1],G.position[2]),x.uniform3f(T.uniforms.lightAmbientColor,G.ambient.r,G.ambient.g,G.ambient.b),x.uniform3f(T.uniforms.lightDiffuseColor,G.diffuse.r,G.diffuse.g,G.diffuse.b),x.uniform3f(T.uniforms.lightSpecularColor,G.specular.r,G.specular.g,G.specular.b),x.uniform1f(T.uniforms.lightShininess,32)}function l(){var t=b.boundingBox();t.translate(t.center());var e=[t.corner(7)[0],t.corner(7)[1],t.corner(7)[2],t.corner(6)[0],t.corner(6)[1],t.corner(6)[2],t.corner(5)[0],t.corner(5)[1],t.corner(5)[2],t.corner(4)[0],t.corner(4)[1],t.corner(4)[2],t.corner(3)[0],t.corner(3)[1],t.corner(3)[2],t.corner(2)[0],t.corner(2)[1],t.corner(2)[2],t.corner(1)[0],t.corner(1)[1],t.corner(1)[2],t.corner(0)[0],t.corner(0)[1],t.corner(0)[2]];x.bindBuffer(x.ARRAY_BUFFER,M),x.bufferData(x.ARRAY_BUFFER,new Float32Array(e),x.STATIC_DRAW);var r=[0,0,0,1,1,0,0,1,0,1,0,1,1,1,0,1,0,0,1,1,1,0,1,1,0,1,1,1,1,1,1,1];x.bindBuffer(x.ARRAY_BUFFER,y),x.bufferData(x.ARRAY_BUFFER,new Float32Array(r),x.STATIC_DRAW);var i=[2,0,4,2,4,6,1,0,2,1,2,3,0,5,4,0,1,5,2,6,7,2,7,3,1,7,5,1,3,7,4,7,6,4,5,7];x.bindBuffer(x.ELEMENT_ARRAY_BUFFER,x.createBuffer()),x.bufferData(x.ELEMENT_ARRAY_BUFFER,new Uint16Array(i),x.STATIC_DRAW)}function c(){E.bind(),E.attachColor(E.tex,0),x.clear(x.COLOR_BUFFER_BIT),x.cullFace(x.FRONT),E.tex.bind(0);for(var t=0;C>t;t++)N[t].bind(t+1);A.tex.bind(++t),z.bind(++t),g(T),E.unbind(),x.disable(x.CULL_FACE)}function g(t){x.viewport(0,0,w,D),t.bind(),x.bindBuffer(x.ARRAY_BUFFER,y),t.vertexAttribPointer("aVertexColor",4,x.FLOAT),x.bindBuffer(x.ARRAY_BUFFER,M),t.vertexAttribPointer("aVertexPosition",3,x.FLOAT),x.drawElements(x.TRIANGLES,36,x.UNSIGNED_SHORT,0),x.viewport(0,0,U,B)}function d(){A.bind(),A.attachColor(A.tex,0),x.clear(x.COLOR_BUFFER_BIT|x.DEPTH_BUFFER_BIT),x.enable(x.CULL_FACE),x.cullFace(x.BACK),g(S),A.unbind()}function _(){x.viewport(0,0,U,B),E.tex.bind(0),F.bind(),F.drawArrays(x.TRIANGLE_STRIP,0,4),x.viewport(0,0,w,D)}function m(){V.push(0,new i(0,0,0,0)),V.push(.02,new i(64,0,0,36)),V.push(.06,new i(255,0,0,107)),V.push(.08,new i(128,128,0,143)),V.push(.1,new i(255,255,255,179)),V.push(1,new i(255,255,255,255)),V.createData()}function v(){z.bind(),z.updatePixels(V.data,x.RGBA),T.bind(),x.uniform1f(T.uniforms.transferMinValue,V.getRangeMin()),x.uniform1f(T.uniforms.transferRangeValue,V.getRangeMax()-V.getRangeMin())}function p(){T.bind(),x.uniform3f(T.uniforms.viewVector,I.pos[0],I.pos[1],I.pos[2]),x.uniformMatrix4fv(T.uniforms.uPMatrix,!1,I.pMatrix),x.uniformMatrix4fv(T.uniforms.uMVMatrix,!1,I.mvMatrix),S.bind(),x.uniformMatrix4fv(S.uniforms.uPMatrix,!1,I.pMatrix),x.uniformMatrix4fv(S.uniforms.uMVMatrix,!1,I.mvMatrix)}var x,b,E,R,A,T,S,F,M,y,w=0,D=0,U=0,B=0,P=[],C=0,N=[],O=!0,L=!1,I=new s(10,0,0,-800);I.addObserver(p);var V,z,G={position:[0,-1,0],directional:!0,ambient:new i(0,0,0,0),diffuse:new i(1,1,1,0),specular:new i(1,1,1,0)},X=0;return{init:function(t,i,n,s){x=t,w=i,D=n,U=i,B=n,x.viewport(0,0,w,D),E=new e(x),E.tex=new r(x,w,D,x.RGBA),R=E.tex,M=x.createBuffer(),y=x.createBuffer(),A=new e(x),A.createDepthRenderBuffer(w,w,x.DEPTH_ATTACHMENT),A.tex=new r(x,w,D,x.RGBA),F=a(),S=o(),this.setVolume(s),x.enable(x.DEPTH_TEST),x.enable(x.BLEND)},setVolume:function(t){b=t;var e=Math.floor(x.getParameter(x.MAX_TEXTURE_SIZE)/t._imageWidth);e*=e;for(var i=[],s=0,a=0;a+e<t._imgContainer.length;)i[s]=t.slice(a,a+e),a+=e,P[s]=e,s++;for(i[s]=t.slice(a,t._imgContainer.length),P[s]=t._imgContainer.length-a,C=i.length,N.forEach(function(t){x.deleteTexture(t.tex)}),s=0;C>s;s++)N[s]=new r(x,i[s]);X=b._maxDensity-b._minDensity+1,z?z.changeSize(X,1):z=new r(x,X,1,x.RGBA),T&&x.deleteProgram(T.getProgram()),T=h(),u(),l(),V?V.setRange(b._minDensity,b._maxDensity):(V=new n(b._minDensity,b._maxDensity),V.addObserver(v),m()),v(),p()},draw:function(){x.clearColor(0,0,0,0),d(),c(),_()},changeRes:function(t,e){w=t,D=e,x.viewport(0,0,w,D),E.tex.changeSize(t,e),A.changeRenderBufferSize(w,w,x.DEPTH_ATTACHMENT),A.tex.changeSize(t,e),T.bind(),x.uniform2f(T.uniforms.textureSize,w,D)},changeResultTexture:function(){return R==E.tex?void(R=A.tex):void(R=E.tex)},loadTransferBuffer:function(t){for(var e=new DataView(t.buffer),r=new n(b._minDensity,b._maxDensity),s=t[0],a=0;s>a;a++){var o=(e.getFloat32(8*a+1)-r._min)/(r._max-r._min),h=new i(t[8*a+5],t[8*a+6],t[8*a+7],t[8*a+8]);r.push(o,h)}r.addObserver(v),V=r,v()},setTransfer:function(t){t.setRange(b._minDensity,b._maxDensity),t.addObserver(v),V=t,v()},restartProgram:function(t,e){O=t,L=e,T=h(),u(),T.bind(),x.bindBuffer(x.ARRAY_BUFFER,y),T.vertexAttribPointer("aVertexColor",4,x.FLOAT),x.bindBuffer(x.ARRAY_BUFFER,M),T.vertexAttribPointer("aVertexPosition",3,x.FLOAT),x.uniform1f(T.uniforms.transferMinValue,V.getRangeMin()),x.uniform1f(T.uniforms.transferRangeValue,V.getRangeMax()-V.getRangeMin()),x.uniform3f(T.uniforms.viewVector,I.pos[0],I.pos[1],I.pos[2]),x.uniformMatrix4fv(T.uniforms.uPMatrix,!1,I.pMatrix),x.uniformMatrix4fv(T.uniforms.uMVMatrix,!1,I.mvMatrix)},changeLightDirection:function(t,e){G.position[t]=e,T.bind(),x.uniform3f(T.uniforms.lightDirection,G.position[0],G.position[1],G.position[2])},observedUpdate:function(){v()},get_resultTexture:function(){return R},get_transfer:function(){return V},get_camera:function(){return I},toJSON:function(){return{width:w,height:D,camera:I,transfer:V,volumeProgram:S,endFBO:A}}}});})();